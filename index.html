<!doctype html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QualityeXchange</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">

  <style>
.reply-box {
  position: fixed;
  bottom: 56px; /* di atas kolom input */
  left: 0;
  width: 100%;
  background: #202c33;
  border-left: 4px solid white;
  padding: 10px 14px;
  box-sizing: border-box;
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 9999; /* biar di atas input */
  animation: slideUp 0.25s ease;
}

@keyframes slideUp {
  from {
    transform: translateY(15px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

.reply-box .reply-content {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  text-overflow: ellipsis;
}

.reply-box .reply-sender {
  color: white;
  font-weight: bold;
  font-size: 14px;
}

.reply-box .reply-text {
  color: #ccc;
  font-size: 13px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.reply-box button {
  background: transparent;
  border: none;
  color: #aaa;
  font-size: 20px;
  cursor: pointer;
  transition: 0.2s;
}
.reply-box button:hover {
  color: #fff;
}
#typingIndicator {
  position: fixed;
  bottom: 70px; /* pas di atas kolom input */
  left: 6px;
  display: flex;
  align-items: center;
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.3s ease;
  z-index: 40;
}
#typingIndicator.show {
  opacity: 1;
  transform: translateY(0);
}
#typingAvatars img {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 2px solid #111b21;
  object-fit: cover;
}
.bubble {
  background: #2a3942;
}
@keyframes bounce1 {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
@keyframes bounce2 {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
@keyframes bounce3 {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
.dot {
  animation: bounce1 1.4s infinite ease-in-out both;
}
.dot:nth-child(2) {
  animation-name: bounce2;
  animation-delay: 0.16s;
}
.dot:nth-child(3) {
  animation-name: bounce3;
  animation-delay: 0.32s;
}

/* Gaya untuk pesan yang dihapus */
.deleted-message {
  color: #9ca3af; /* abu-abu netral */
  font-style: italic;
}

#customPlaceholder {
  font-style: italic;
  color: #9ca3af;
  z-index: 10;
}

/* --- Popup verifikasi animasi fix --- */
#verifyOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 99;
}

#verifyOverlay.show {
  opacity: 1;
}

#verifyOverlay.hidden {
  display: none;
}

#verifyPopup {
  background: #1f2a36;
  color: #fff;
  border-radius: 20px 20px 0 0;
  text-align: center;
  width: 100%;
  max-width: 450px;
  padding: 30px 20px;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
  box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
}

#verifyPopup.show {
  transform: translateY(0);
}

#verifyPopup.hide {
  transform: translateY(100%);
}

/* Tambahan efek bounce kecil */
#verifyPopup.show {
  animation: popup-bounce 0.4s ease-out;
}

@keyframes popup-bounce {
  0% {
    transform: translateY(100%);
  }
  70% {
    transform: translateY(0);
  }
  100% {
    transform: translateY(0);
  }
}
/* Placeholder jadi miring dan abu-abu saat disabled */
input[disabled]::placeholder {
  font-style: italic;
  color: #9ca3af; /* abu-abu lembut */
}

/* warna background input nonaktif */
input[disabled] {
  background-color: transparent;
  color: #9ca3af;
  cursor: not-allowed;
}

    :root { --vh: 100%; }
    body {
  background-color: #0b141a;
  color: #fff;
  font-family: 'Inter', sans-serif;
  display: flex;
  flex-direction: column;
  min-height: calc(var(--vh, 1vh) * 100);
  overflow-x: hidden;
  overflow-y: auto;
}

/* Box reply di atas kolom input */
#replyBox {
  position: absolute;
  bottom: 60px; /* pas di atas input */
  left: 0;
  right: 0;
  background-color: #202c33; /* abu-abu gelap seperti WA */
  border-left: 4px solid #00a884; /* warna hijau WA */
  color: #e9edef;
  padding: 8px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
  transition: all 0.3s ease;
}

/* Saat disembunyikan */
#replyBox.hidden {
  transform: translateY(100%);
  opacity: 0;
  pointer-events: none;
}

/* Teks pengirim */
#replySender {
  font-weight: 600;
  color: #53bdeb;
  font-size: 14px;
}

/* Teks isi chat yang direply */
#replyText {
  font-size: 13px;
  color: #cfd4d8;
  max-width: 240px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Tombol close (X) */
#cancelReply {
  background: transparent;
  border: none;
  color: #8696a0;
  font-size: 20px;
  cursor: pointer;
}
#cancelReply:hover {
  color: #fff;
}
    
    
.verified-badge {
  display: inline-block;
  vertical-align: middle;
  margin-top: -2px; /* sedikit naik supaya sejajar sempurna */
}

.verified-badge-style-two {
  display: inline-block;
  vertical-align: middle;
  margin-top: -0.4px; /* sedikit naik supaya sejajar sempurna */
}
  
#chatArea {
  height: calc(var(--vh, 1vh) * 100 - 70px);
  overflow-y: auto;
  scroll-behavior: smooth;
  transition: scroll 0.4s ease-out;
  width: 100%;
  padding-bottom: 120px;
  box-sizing: border-box;
}
footer {
  position: fixed !important;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 900px; /* agar tetap proporsional di tengah */
  z-index: 50;
}

#loginOverlay {
  backdrop-filter: blur(2px);
  font-weight: 500;
}
  </style>
</head>
<body class="min-h-screen flex flex-col" id="body">

  <!-- Header -->
    <header class="sticky top-0 z-20 flex justify-between items-center bg-[#202c33] px-4 py-3 shadow-md">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full overflow-hidden">
        <img src="
        https://cf.admin.appmysite.com/720961/735856/app_icon/display_image/ams_1760860527_6312.png"
             alt="pp saluran" class="w-full h-full object-cover">
      </div>
      <div class="flex flex-col text-sm sm:text-base">
        <span class="font-semibold flex items-center gap-1 text-white">

            
           QualityeXchange
         

          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/Twitter_Verified_Badge_Gold.svg/2048px-Twitter_Verified_Badge_Gold.svg.png"
               alt="verified"
               class="w-3.5 h-3.5 sm:w-4 sm:h-4 object-contain" />
               
         
        </span>
    <span id="chatStatus" class="text-xs sm:text-sm text-gray-400">
       103.293 member
    </span>
      </div>
    </div>

    <!-- User/Login Area -->
    <div id="userArea" class="hidden text-sm sm:text-base">
      <button id="loginBtn" class="bg-transparent px-2 py-1 rounded-lg transition text-white">                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/480px-Google_%22G%22_logo.svg.png"
               alt="verified"
               class="w-6 h-6 sm:w-5 sm:h-5 object-contain" /></button>
    </div>
  </header>

<section class="flex-1 overflow-hidden relative">
  <div id="chatArea"
       class="absolute inset-0 overflow-y-auto bg-[url('https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg')] bg-cover bg-center p-3 sm:p-4 space-y-3 sm:space-y-4">
  </div>
</section>
  
<!-- Typing indicator (versi grup) -->
<div id="typingIndicator" class="hidden flex items-center gap-2 px-4 pb-2">
  <div id="typingAvatars" class="flex -space-x-3"></div>
  <div class="bubble flex items-center justify-center px-3 py-2 bg-[#2a3942] rounded-2xl">
    <div class="dot bg-gray-400 w-2 h-2 rounded-full mx-[2px] animate-bounce1"></div>
    <div class="dot bg-gray-400 w-2 h-2 rounded-full mx-[2px] animate-bounce2"></div>
    <div class="dot bg-gray-400 w-2 h-2 rounded-full mx-[2px] animate-bounce3"></div>
  </div>
</div>

<!-- Input Area -->
<footer class="flex items-center gap-2 sm:gap-3 bg-[#202c33] p-2 sm:p-3 relative">
  <!-- Tombol + -->
  <button id="openStickerBtn"
          class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[#2a3942] hover:bg-[#3b4a54] flex items-center justify-center text-white transition">
    <i class="ri-add-line text-xl"></i>
  </button>
  
  <!-- Tombol Admin Panel -->
<button id="adminPanelBtn"
        class="hidden w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[#2a3942] hover:bg-[#3b4a54] flex items-center justify-center text-white transition">
  <i class="ri-settings-3-line text-xl"></i>
</button>

<div id="replyBox" class="reply-box hidden">
  <div class="reply-info">
    <strong id="replyUser"></strong>
    <span id="replyText"></span>
  </div>
  <button id="cancelReply">&times;</button>
</div>

  <!-- Input -->
  <div class="flex items-center flex-1 bg-[#2a3942] rounded-full px-3 sm:px-4 py-2 sm:py-3">
    <input id="messageInput"
           type="text"
           placeholder="Ketik pesan..."
           class="flex-1 bg-transparent text-sm sm:text-base text-white outline-none placeholder-gray-400" />
           
  </div>
  <div id="customPlaceholder" class="absolute left-4 bottom-3 text-gray-400 italic flex items-center pointer-events-none hidden">
  <i class="ri-forbid-2-line text-gray-400 text-base mr-1"></i> Login terlebih dahulu untuk mengirim pesan!
</div>

  <!-- Tombol kirim -->
  <button id="sendBtn"
          class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-blue-400 hover:bg-blue-500 flex items-center justify-center transition">
    <i class="ri-send-plane-2-fill text-lg sm:text-xl text-white"></i>
  </button>

  <!-- Popup Sticker -->
  <div id="stickerPanel"
       class="hidden absolute bottom-16 left-2 bg-[#1f2c34] p-3 rounded-2xl shadow-xl grid grid-cols-4 sm:grid-cols-5 gap-2 border border-gray-700 z-50">
    <!-- contoh gambar sticker -->
    <img src="https://media.tenor.com/lD7DpilxezIAAAAM/cerydra-cery-dra.gif" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
    <img src="https://i.pinimg.com/736x/f7/0f/57/f70f577fb62c9a3743b5f5d4902d7466.jpg" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
        <img src="https://media2.giphy.com/media/v1.Y2lkPTZjMDliOTUybW04Z2Zjdm1qd245MXBrcDQ0OHljbGRzbzZlaHF5c3RsZGVua3A4aSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Q0VvDkS4j4Ia2RjAOS/giphy.gif" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRSK1mjjJGbSU1_G-zv7LtSPnVTykBIXxXLI3-U7KaahI0TjOM5c21k1SQ&s=10" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
                        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQTktTYdgsjpaqCWN3z-O1g_37gpJgCEjbp_qD_3Y_9kzBk_14sRENQ5f_D&s=10" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTHfyz8wy1dbJfPOSGoCPzKrp69v4fxpBQo_Q4v-axvk10IpgWr_PeKcoM&s=10" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
                                        <img src="https://i.pinimg.com/564x/16/93/df/1693dfbde6b9be3373c242a0d258aefe.jpg" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
                                                                                <img src="https://i.pinimg.com/236x/b8/41/c0/b841c003508288e34ebf5da7e50fb23f.jpg" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
  </div>
</footer>

<!-- Overlay untuk user yang belum login -->
<div id="loginOverlay"
     class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 flex items-center justify-center text-gray-300 text-sm sm:text-base py-4 z-40 hidden">
  Login terlebih dahulu!
</div>

<div id="verifyOverlay" class="hidden">
  <div id="verifyPopup" class="flex flex-col items-center">

    <div class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center mb-3">
      <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/Twitter_Verified_Badge_Gold.svg/2048px-Twitter_Verified_Badge_Gold.svg.png"
           alt="verified"
           class="w-8 h-8 object-contain" />
    </div>

    <h3 class="text-lg font-semibold">Terverifikasi</h3>

    <p class="text-gray-400 text-sm mt-2 leading-relaxed text-center">
      KSD, perusahaan induk QualityeXchange, telah memverifikasi akun ini berdasarkan aktivitasnya di seluruh produk kami serta informasi atau dokumen yang mereka sediakan.
    </p>

    <p class="text-[#4ba3ff] text-sm mt-3">
      KSD Verification. Powered by QualityeXchange
    </p>
  </div>
</div>

<script>
function adjustViewportHeight() {
  const vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
adjustViewportHeight();
window.addEventListener('resize', adjustViewportHeight);
window.addEventListener('orientationchange', adjustViewportHeight);
</script>

<script type="module">
  import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  getDatabase,
  ref,
  set,
  push,
  update,
  onChildAdded,
  onChildChanged,
  onValue,
  onDisconnect,
  remove
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBCz40oTe3y1bcpfxZY8wl4ZPf-Jm-Yn08",
    authDomain: "group-chat-5eb24.firebaseapp.com",
    projectId: "group-chat-5eb24",
    storageBucket: "group-chat-5eb24.firebasestorage.app",
    databaseURL: "https://group-chat-5eb24-default-rtdb.firebaseio.com",
    messagingSenderId: "1035715492375",
    appId: "1:1035715492375:web:3543ae1fcdecea8c0e7a52"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, "cerydra_group");
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatArea = document.getElementById("chatArea");
  const userArea = document.getElementById("userArea");
  const popup = document.getElementById("newMsgPopup");

  let username = localStorage.getItem("username") || "Guest_" + Math.floor(Math.random() * 1000);
  let isLoggedIn = false;
  let newMsgCount = 0;
  let isNearBottom = true;
  // === SISTEM REPLY DENGAN DESAIN DINAMIS ===
let replyTarget = null;
let replyPreviewEl = null;

function showReplyBox(sender, text, isSticker = false) {
  clearReplyBox(); // hapus yang lama

  // buat elemen reply box baru
  replyPreviewEl = document.createElement("div");
  replyPreviewEl.className = "reply-box"; // pakai CSS desain yang sudah ada

  // batasi teks dan nama
  const displaySender = sender.length > 20 ? sender.substring(0, 20) + "..." : sender;
  const displayText = isSticker ? "(Sticker)" : (text || "").substring(0, 40);

  replyPreviewEl.innerHTML = `
    <div class="reply-content">
      <span class="reply-sender">@${displaySender}</span>
      <span class="reply-text">${displayText}</span>
    </div>
    <button id="cancelReply">&times;</button>
  `;

  // tambahkan ke dalam <footer> agar posisinya tetap di atas input
  const footer = document.querySelector("footer");
  footer.appendChild(replyPreviewEl);

  // event tombol Ã—
  const cancelBtn = replyPreviewEl.querySelector("#cancelReply");
  cancelBtn.addEventListener("click", clearReplyBox);

  // simpan data target
  replyTarget = { sender, text, isSticker };
}

function clearReplyBox() {
  if (replyPreviewEl) {
    replyPreviewEl.remove();
    replyPreviewEl = null;
  }
  replyTarget = null;
}

// === GESTURE SWIPE KANAN UNTUK REPLY ===
function enableReplyGesture(bubble, sender) {
  let startX = 0;
  bubble.addEventListener("touchstart", e => (startX = e.touches[0].clientX));
  bubble.addEventListener("touchend", e => {
    const diff = e.changedTouches[0].clientX - startX;
    if (diff > 60) triggerReply(bubble, sender);
  });

  bubble.addEventListener("mousedown", e => (startX = e.clientX));
  bubble.addEventListener("mouseup", e => {
    const diff = e.clientX - startX;
    if (diff > 60) triggerReply(bubble, sender);
  });
}

function triggerReply(bubble, sender) {
  const messageBody = bubble.querySelector(".message-body");
  const hasImage = messageBody && messageBody.querySelector("img");

  const isSticker = !!hasImage;
  const text = messageBody ? messageBody.innerText.trim() : "";

  replyTarget = { sender, text, isSticker };
  showReplyBox(sender, text, isSticker);
}



  

// === Typing Indicator (Grup Style) ===
const typingRef = ref(db, "typing");
const typingIndicator = document.getElementById("typingIndicator");
const typingAvatars = document.getElementById("typingAvatars");
const messageInput = document.getElementById("messageInput");

onAuthStateChanged(auth, user => {
  if (user) {
    const userTypingRef = ref(db, `typing/${user.uid}`);
    let typingTimeout;

    messageInput.addEventListener("input", () => {
      set(userTypingRef, {
        email: user.email,
        photoURL: user.photoURL,
        typing: true
      });

      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        remove(userTypingRef);
      }, 300);
    });

    onDisconnect(userTypingRef).remove();
  }
});

// ðŸ”¹ Tampilkan semua user yang sedang mengetik
onValue(typingRef, snapshot => {
  const typingUsers = [];
  snapshot.forEach(child => {
    const val = child.val();
    if (val && val.typing) {
      typingUsers.push(val.photoURL || "https://cdn-icons-png.flaticon.com/512/149/149071.png");
    }
  });

  if (typingUsers.length > 0) {
    typingAvatars.innerHTML = typingUsers
      .map((url, i) => `<img src="${url}" style="z-index:${100 - i}">`)
      .join("");
    typingIndicator.classList.add("show");
    typingIndicator.classList.remove("hidden");
  } else {
    typingIndicator.classList.remove("show");
    setTimeout(() => typingIndicator.classList.add("hidden"), 300);
  }
});

  function shortName(name) {
    return name.length > 3 ? name.substring(0, 3).toUpperCase() + "..." : name.toUpperCase();
  }

function updateUserUI(user) {
  if (user) {
    isLoggedIn = true;
    username = user.displayName || username;
    localStorage.setItem("username", username);

    // âœ… Cek apakah user adalah admin terverifikasi
    const verifiedAdmins = [
      "drevviann@gmail.com",
      "ridhofadillah1010@gmail.com"
    ];
    const isVerified = verifiedAdmins.includes(user.email);

    // âœ… Jika admin, beri centang  golden di navbar
    const verifiedBadge = isVerified
  ? `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/Twitter_Verified_Badge_Gold.svg/2048px-Twitter_Verified_Badge_Gold.svg.png"
          alt="verified"
          class="verified-badge w-3.5 h-3.5 ml-1" />`
  : "";

    const displayName = shortName(username);
    userArea.innerHTML = `
      <div class="flex items-center gap-2">
        <img src="${user.photoURL || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRCIzI0ns7NQEyDF3q4uSycytPQglRhRPVNm4s1qWhdUg&s=10"}"
             class="w-8 h-8 rounded-full border border-gray-600">
        <span id="displayUsername" class="font-medium ${isVerified ? 'text-white' : 'text-white'}">${displayName}${verifiedBadge}</span>
        <i id="editName" class="ri-pencil-line text-gray-300 hover:text-white text-lg cursor-pointer"></i>
        <i id="logoutBtn" class="ri-logout-box-r-line text-red-400 hover:text-red-500 text-lg cursor-pointer"></i>
      </div>
    `;

    document.getElementById("editName").addEventListener("click", editUsername);
    document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));
  } else {
    isLoggedIn = false;
    userArea.innerHTML = `
      <button id="loginBtn"
              class="bg-transparent px-2 py-1 rounded-lg transition text-white">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/480px-Google_%22G%22_logo.svg.png"
             alt="google login"
             class="w-6 h-6 sm:w-5 sm:h-5 object-contain" />
      </button>`;
    document.getElementById("loginBtn").addEventListener("click", handleLogin);
    
  }
  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  if (user) {
    // âœ… User sudah login
    input.disabled = false;
    input.placeholder = "Kirim pesan...";
    sendBtn.disabled = false;
    sendBtn.classList.remove("opacity-50", "cursor-not-allowed");
} else {
    input.disabled = true;
    input.placeholder = "hanya admin yang bisa mengirim pesan!";
    sendBtn.disabled = true;
    sendBtn.classList.add("opacity-50", "cursor-not-allowed");
  }
}

  function handleLogin() {
    signInWithPopup(auth, provider)
      .then(result => updateUserUI(result.user))
      .catch(err => console.error("Login error:", err));
  }

  function editUsername() {
    if (!isLoggedIn) return alert("Hanya pengguna login yang bisa mengganti nama!");
    const newName = prompt("Ubah nama (maks. 12 karakter):", username);
    if (!newName) return;
    if (newName.length > 12) return alert("Maksimal 12 karakter!");
    username = newName.trim();
    localStorage.setItem("username", username);
    document.getElementById("displayUsername").innerText = shortName(username);
  }

  onAuthStateChanged(auth, user => updateUserUI(user));

function renderMessage(text, sender, time, email = null, photoURL = null, messageId = null) {    // Potong nama jika lebih dari 12 karakter
  const displayName = sender.length > 12 ? sender.substring(0, 12) + "..." : sender;
  const currentUser = auth.currentUser;
  const isYou = currentUser && email === currentUser.email;

  // ðŸ”¹ daftar akun terverifikasi
  const verifiedUsers = [
  "drevviann@gmail.com",
  "ridhofadillah1010@gmail.com"
];

const premiumUsers = [
  "premiumuser@gmail.com",
  "limitbreak@gmail.com"
];
  const isVerified = verifiedUsers.includes(email);

  // wrapper bubble
  const wrapper = document.createElement("div");
  wrapper.className = `w-full flex ${isYou ? "justify-end" : "justify-start"} mb-3`;

  // bubble chat
  const bubble = document.createElement("div");
  bubble.className = `
    ${isYou ? "bg-[#005c4b]" : "bg-[#1f1f1f]"}
    text-gray-200 rounded-2xl px-3 py-2 max-w-[80%] text-sm shadow
    flex flex-col items-start
  `
  bubble.dataset.id = messageId;
  
  // ðŸ§© Tekan-tahan untuk hapus pesan sendiri
  let pressTimer;
  if (auth.currentUser && auth.currentUser.email === email && !text.includes("Pesan ini sudah dihapus")) { 
    const startPress = () => {
      pressTimer = setTimeout(() => {
        showDeletePopup(messageId);
      }, 700);
    };
    const endPress = () => clearTimeout(pressTimer);

    bubble.addEventListener("mousedown", startPress);
    bubble.addEventListener("mouseup", endPress);
    bubble.addEventListener("mouseleave", endPress);
    bubble.addEventListener("touchstart", startPress);
    bubble.addEventListener("touchend", endPress);
  }
  

  // ðŸ”¹ centang biru jika terverifikasi
  const verifiedBadge = isVerified
    ? `<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/81/Twitter_Verified_Badge_Gold.svg/2048px-Twitter_Verified_Badge_Gold.svg.png"
             alt="verified" class="w-3.5 h-3.5 ml-1 inline-block align-middle verified-badge-style-two" />`
    : "";

  // ðŸ”¹ Baris atas: foto profil di kiri nama + waktu di kanan
  const headerHTML = `
  <div class="flex items-center w-full mb-1">
    <img src="${photoURL || 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRkjFpo1MyqtOZpX9eN2FpREP7noUsAvV_IDw&usqp=CAU'}"
         alt="profile"
         class="w-6 h-6 rounded-full object-cover mr-2" />
<span class="font-medium ${isVerified ? "text-white" : "text-white"}">${displayName}</span>
    ${verifiedBadge}
    <span class="text-[11px] text-gray-400 ml-2">${time}</span>
  </div>
`;

  // ðŸ”¹ Deteksi pesan teks atau sticker
  const contentHTML = text.includes("<img")
  ? `<div class="mt-1 w-full flex justify-center message-body">${text}</div>`
  : `<div class="break-words leading-tight text-left text-white w-full message-body">${text}</div>`;

  bubble.innerHTML = headerHTML + contentHTML;
  wrapper.appendChild(bubble);
  chatArea.appendChild(wrapper);
  enableReplyGesture(bubble, sender);

}

function showDeletePopup(messageId) {
  const popup = document.createElement("div");
  popup.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
  popup.innerHTML = `
    <div class="bg-[#1f2c34] text-white p-4 rounded-2xl w-72 shadow-lg border border-gray-700">
      <p class="mb-4">Hapus pesan ini?</p>
      <button id="deleteForAll" class="w-full bg-transparent border border-red-700 rounded-lg py-2 mb-2">
        Hapus untuk semua orang
      </button>
      <button id="cancelDelete" class="w-full bg-transparent border border-white rounded-lg py-2">
        Batal
      </button>
    </div>
  `;
  document.body.appendChild(popup);

  // tombol hapus
  document.getElementById("deleteForAll").addEventListener("click", async () => {
    await update(ref(db, "cerydra_group/" + messageId), {
  text: "<i class='ri-forbid-2-line text-gray-400 text-base mr-1 align-middle'></i> <span class='deleted-message'>Pesan ini telah dihapus</span>"
});
    document.body.removeChild(popup);
  });

  document.getElementById("cancelDelete").addEventListener("click", () => {
    document.body.removeChild(popup);
  });
}

// ðŸ”¥ Saat ada pesan baru
onChildAdded(chatRef, snapshot => {
  const m = snapshot.val();
  if (!m) return;

  renderMessage(m.text, m.sender, m.time, m.email, m.photoURL, snapshot.key);

  // âœ… Tambahkan auto scroll setelah pesan baru dirender
  requestAnimationFrame(() => {
    smoothScrollToBottom(chatArea);
  });
});
// ðŸ”¥ Saat pesan diubah (misalnya dihapus)
onChildChanged(chatRef, snapshot => {
  const m = snapshot.val();
  const bubble = document.querySelector(`[data-id='${snapshot.key}']`);
  if (!bubble || !m) return;

  // cari elemen teks di dalam bubble
  const messageBody = bubble.querySelector(".message-body");
  if (messageBody) {
    messageBody.innerHTML = m.text;
  } else {
    // kalau struktur berbeda, fallback: ganti seluruh isi
    bubble.innerHTML = `
      <div class="message-header flex items-center gap-2">
        <img src="${m.photoURL || "https://cdn-icons-png.flaticon.com/512/4712/4712035.png"}" class="w-6 h-6 rounded-full">
        <span class="font-medium">${m.sender}</span>
        <span class="text-xs text-gray-400 ml-2">${m.time}</span>
      </div>
      <div class="message-body mt-1">${m.text}</div>
    `;
  }
});

// Animasi scroll halus
function smoothScrollToBottom(element) {
  const start = element.scrollTop;
  const end = element.scrollHeight - element.clientHeight;
  const distance = end - start;
  if (distance < 5) return;

  const duration = 500;
  const startTime = performance.now();

  function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  function animate(time) {
    const elapsed = time - startTime;
    const progress = Math.min(elapsed / duration, 1);
    element.scrollTop = start + distance * easeOutCubic(progress);
    if (progress < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

// === KIRIM PESAN ===
sendBtn.addEventListener("click", () => {
  if (!isLoggedIn) return alert("Silakan login terlebih dahulu!");
  const text = input.value.trim();
  if (!text) return;

  const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  const currentUser = auth.currentUser;
  let messageText = text;

if (replyTarget) {
  const repliedText = replyTarget.isSticker ? "(Sticker)" : replyTarget.text;
  messageText = `
    <div class='text-sm border-l-4 border-gray-500 pl-2 mb-1 text-gray-300'>
      Replied to @${replyTarget.sender}: ${repliedText}
    </div>${text}`;
  clearReplyBox();
}

  push(chatRef, {
    text: messageText,
    sender: username,
    time,
    email: currentUser.email,
    photoURL:
      currentUser.photoURL ||
      "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRCIzI0ns7NQEyDF3q4uSycytPQglRhRPVNm4s1qWhdUg&s=10"
  });

  input.value = "";
  input.focus();
});
  
  // --- Panel Sticker ---
const openStickerBtn = document.getElementById("openStickerBtn");
const stickerPanel = document.getElementById("stickerPanel");

openStickerBtn.addEventListener("click", () => {
  stickerPanel.classList.toggle("hidden");
});

// Klik di luar panel â†’ sembunyikan
document.addEventListener("click", (e) => {
  if (!stickerPanel.contains(e.target) && !openStickerBtn.contains(e.target)) {
    stickerPanel.classList.add("hidden");
  }
});

// Klik salah satu sticker â†’ kirim URL-nya sebagai pesan
stickerPanel.querySelectorAll("img").forEach(img => {
  img.addEventListener("click", () => {
    if (!isLoggedIn) return alert("Silakan login untuk mengirim pesan!");
    const currentUser = auth.currentUser;
    const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

    push(chatRef, {
  text: `<img src="${img.src}" class='w-32 h-32 rounded-lg' />`,
  sender: username,
  time,
  email: currentUser.email,
  photoURL: currentUser.photoURL || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRCIzI0ns7NQEyDF3q4uSycytPQglRhRPVNm4s1qWhdUg&s=10"
});

    stickerPanel.classList.add("hidden");
    chatArea.scrollTop = chatArea.scrollHeight;
  });
});

const verifyPopup = document.getElementById("verifyPopup");
const verifyOverlay = document.getElementById("verifyOverlay");

function openVerifyPopup() {
  verifyPopup.classList.add("show");
  verifyPopup.classList.remove("hide");
  verifyOverlay.classList.remove("hidden");
  verifyOverlay.classList.add("show");
}

function closeVerifyPopup() {
  verifyPopup.classList.add("hide");
  verifyPopup.classList.remove("show");
  verifyOverlay.classList.remove("show");
  setTimeout(() => verifyOverlay.classList.add("hidden"), 300);
}

// Event untuk semua centang biru (ikon Remixicon atau gambar alt="verified")
document.addEventListener("click", e => {
  if (
    e.target.classList.contains("ri-verified-badge-fill") ||
    e.target.classList.contains("ri-verified-badge-line") ||
    e.target.alt === "verified"
  ) {
    e.stopPropagation();
    openVerifyPopup();
  }
});

// Tutup popup bila klik area overlay
verifyOverlay.addEventListener("click", closeVerifyPopup);







</script>
</body>
</html>