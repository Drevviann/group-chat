<!doctype html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Komunitas Cerydra</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root { --vh: 100%; }
    body {
      background-color: #0b141a;
      color: #fff;
      font-family: 'Inter', sans-serif;
      display: flex;
      overflow: hidden;
      flex-direction: column;
      height: calc(var(--vh, 1vh) * 100);
    }
    
#chatArea {
  overflow-y: auto;
  scroll-behavior: smooth;
  transition: scroll 0.4s ease-out;
  height: 100%;
  width: 100%;
  will-change: scroll-position;
}
    main {
  flex: 1;
  overflow-y: auto;
  scroll-behavior: smooth;
}
    footer { position: sticky; bottom: 0; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.1); border-radius: 9999px; }
  </style>
</head>
<body class="min-h-screen flex flex-col" id="body">

  <!-- Header -->
    <header class="sticky top-0 z-20 flex justify-between items-center bg-[#202c33] px-4 py-3 shadow-md">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full overflow-hidden">
        <img src="https://preview.redd.it/i-think-all-3-of-cerydras-design-animations-and-model-are-v0-z7t7a1va8fff1.gif?width=500&auto=webp&s=b019ee031e91d98bf8842e3821fac11679941a99"
             alt="avatar" class="w-full h-full object-cover">
      </div>
      <div class="flex flex-col text-sm sm:text-base">
        <span class="font-semibold flex items-center gap-1 text-white">
          Cerydra
          <img src="https://lookaside.fbsbx.com/elementpath/media/?media_id=778731283935334&version=1760038331"
               alt="verified"
               class="w-3 h-3 sm:w-4 sm:h-4 object-contain" />
        </span>
        <span class="text-xs sm:text-sm text-gray-400">Cerydra Community</span>
      </div>
    </div>

    <!-- User/Login Area -->
    <div id="userArea" class="text-sm sm:text-base">
      <button id="loginBtn" class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded-lg transition text-white"><i class="ri-google-fill text-lg"></i></button>
    </div>
  </header>

<section class="flex-1 overflow-hidden relative">
  <div id="chatArea"
       class="absolute inset-0 overflow-y-auto bg-[url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSXw4_2ttij018oKbf-g2jZbqQ_94vTh7Lqnl2twm0gjQ&s=10')] bg-cover bg-center p-3 sm:p-4 space-y-3 sm:space-y-4">
  </div>
</section>
  
  <!-- ðŸ”” Notifikasi jumlah pesan baru -->
<div id="newMsgPopup"
     class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-full text-sm shadow-lg cursor-pointer z-50 transition">
  1 pesan baru
</div>

  <!-- Input Area -->
  <footer class="flex items-center gap-2 sm:gap-3 bg-[#202c33] p-2 sm:p-3">
    <div class="flex items-center flex-1 bg-[#2a3942] rounded-full px-3 sm:px-4 py-2 sm:py-3">
      <input id="messageInput"
             type="text"
             placeholder="Ketik pesan..."
             class="flex-1 bg-transparent text-sm sm:text-base text-white outline-none placeholder-gray-400" />
    </div>
    <button id="sendBtn"
            class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-blue-400 hover:bg-blue-500 flex items-center justify-center transition">
      <i class="ri-send-plane-2-fill text-lg sm:text-xl text-white"></i>
    </button>
  </footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBCz40oTe3y1bcpfxZY8wl4ZPf-Jm-Yn08",
    authDomain: "group-chat-5eb24.firebaseapp.com",
    projectId: "group-chat-5eb24",
    storageBucket: "group-chat-5eb24.firebasestorage.app",
    databaseURL: "https://group-chat-5eb24-default-rtdb.firebaseio.com",
    messagingSenderId: "1035715492375",
    appId: "1:1035715492375:web:3543ae1fcdecea8c0e7a52"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, "cerydra_group");
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatArea = document.getElementById("chatArea");
  const userArea = document.getElementById("userArea");
  const popup = document.getElementById("newMsgPopup");

  let username = localStorage.getItem("username") || "Guest_" + Math.floor(Math.random() * 1000);
  let isLoggedIn = false;
  let newMsgCount = 0;
  let isNearBottom = true;

  // --- Nama user maksimum 4 huruf ---
  function shortName(name) {
    return name.length > 4 ? name.substring(0, 4).toUpperCase() + "..." : name.toUpperCase();
  }

  // --- Login & UI ---
  function updateUserUI(user) {
    if (user) {
      isLoggedIn = true;
      username = user.displayName || username;
      localStorage.setItem("username", username);
      const isVerified = user.email === "drevviann@gmail.com";
      const verifiedBadge = isVerified
        ? `<img src="https://lookaside.fbsbx.com/elementpath/media/?media_id=778731283935334&version=1760038331"
                alt="verified" class="w-3.5 h-3.5 ml-1 inline-block align-middle" />`
        : "";
      const displayName = shortName(username);
      userArea.innerHTML = `
        <div class="flex items-center gap-2">
          <img src="${user.photoURL || "https://i.imgur.com/0y0y0y0.png"}"
               class="w-8 h-8 rounded-full border border-gray-600">
          <span id="displayUsername" class="font-medium">${displayName}${verifiedBadge}</span>
          <i id="editName" class="ri-pencil-line text-gray-300 hover:text-white text-lg cursor-pointer"></i>
          <i id="logoutBtn" class="ri-logout-box-r-line text-red-400 hover:text-red-500 text-lg cursor-pointer"></i>
        </div>`;
      document.getElementById("editName").addEventListener("click", editUsername);
      document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));
    } else {
      isLoggedIn = false;
      userArea.innerHTML = `
        <button id="loginBtn"
                class="bg-blue-500 hover:bg-blue-600 px-3 py-1 rounded-lg transition text-white flex items-center gap-2">
          <i class="ri-google-fill text-lg"></i>
        </button>`;
      document.getElementById("loginBtn").addEventListener("click", handleLogin);
    }
  }

  function handleLogin() {
    signInWithPopup(auth, provider)
      .then(result => updateUserUI(result.user))
      .catch(err => console.error("Login error:", err));
  }

  function editUsername() {
    if (!isLoggedIn) return alert("Hanya pengguna login yang bisa mengganti nama!");
    const newName = prompt("Ubah nama (maks. 12 karakter):", username);
    if (!newName) return;
    if (newName.length > 12) return alert("Maksimal 12 karakter!");
    username = newName.trim();
    localStorage.setItem("username", username);
    document.getElementById("displayUsername").innerText = shortName(username);
  }

  onAuthStateChanged(auth, user => updateUserUI(user));

function renderMessage(text, sender, time, email = null) {
  const currentUser = auth.currentUser;
  const isYou = currentUser && email === currentUser.email;
  const isVerified = email === "drevviann@gmail.com";

  const wrapper = document.createElement("div");
  wrapper.className = `w-full flex ${isYou ? "justify-end" : "justify-start"}`;

  const bubble = document.createElement("div");
  bubble.className = `
    ${isYou ? "bg-[#005c4b]" : "bg-[#1f1f1f]"}
    text-gray-200 rounded-2xl px-3 py-2 max-w-[80%] text-sm shadow
  `;

  const verifiedBadge = isVerified
    ? `<img src="https://lookaside.fbsbx.com/elementpath/media/?media_id=778731283935334&version=1760038331"
             alt="verified" class="w-3 h-3 ml-1 inline-block align-middle" />`
    : "";

  bubble.innerHTML = `
    <div class='flex items-end gap-2 flex-wrap justify-end'>
      <span class='break-words leading-tight text-white'>${text}</span>
      <span class='flex items-center gap-1 text-[11px] text-gray-300 whitespace-nowrap'>
        ${time}
        ${isYou ? "<i class='ri-check-double-line text-gray-400 text-[13px]'></i>" : ""}
      </span>
    </div>
    ${!isYou ? `<div class='text-[11px] text-gray-400 mt-1 ml-1 flex items-center'>${sender}${verifiedBadge}</div>` : ""}
  `;

  wrapper.appendChild(bubble);
  chatArea.appendChild(wrapper);
}

onChildAdded(chatRef, snapshot => {
  const m = snapshot.val();
  renderMessage(m.text, m.sender, m.time, m.email);

  // Jalankan scroll setelah DOM update
  requestAnimationFrame(() => {
    smoothScrollToBottom(chatArea);
  });
});

// Animasi scroll halus
function smoothScrollToBottom(element) {
  const start = element.scrollTop;
  const end = element.scrollHeight - element.clientHeight;
  const distance = end - start;
  if (distance < 5) return;

  const duration = 500;
  const startTime = performance.now();

  function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  function animate(time) {
    const elapsed = time - startTime;
    const progress = Math.min(elapsed / duration, 1);
    element.scrollTop = start + distance * easeOutCubic(progress);
    if (progress < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

  // --- Kirim pesan ---
  sendBtn.addEventListener("click", () => {
    if (!isLoggedIn) return alert("Silakan login terlebih dahulu!");
    const text = input.value.trim();
    if (!text) return;
    const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    const currentUser = auth.currentUser;
    push(chatRef, { text, sender: username, time, email: currentUser.email })
      .then(() => {
        input.value = "";
        input.focus();
        chatArea.scrollTop = chatArea.scrollHeight;
      })
      .catch(err => console.error("Send error:", err));
  });
</script>
</body>
</html>