<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cerydra Community Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    body { background-color: #0b141a; color: #fff; font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.1); border-radius: 9999px; }
  </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

  <!-- Header -->
  <header class="flex items-center gap-3 bg-[#202c33] px-4 py-3 shadow-md">
    <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full overflow-hidden">
      <img src="https://preview.redd.it/i-think-all-3-of-cerydras-design-animations-and-model-are-v0-z7t7a1va8fff1.gif?width=500&auto=webp&s=b019ee031e91d98bf8842e3821fac11679941a99"
           alt="avatar" class="w-full h-full object-cover">
    </div>
    <div class="flex flex-col text-sm sm:text-base">
      <span class="font-semibold flex items-center gap-1 text-white">
        Cerydra
        <img src="https://lookaside.fbsbx.com/elementpath/media/?media_id=778731283935334&version=1760038331"
             alt="verified"
             class="w-3 h-3 sm:w-4 sm:h-4 object-contain" />
      </span>
      <span class="text-xs sm:text-sm text-gray-400">Cerydra Community</span>
    </div>
  </header>

  <!-- Chat Area -->
  <main id="chatArea"
        class="flex-1 overflow-y-auto bg-[url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSXw4_2ttij018oKbf-g2jZbqQ_94vTh7Lqnl2twm0gjQ&s=10')] bg-cover bg-center p-3 sm:p-4 flex flex-col gap-3 sm:gap-4 transition-all duration-300">
  </main>

  <!-- Input Area -->
  <footer class="flex items-center gap-2 sm:gap-3 bg-[#202c33] p-2 sm:p-3">
    <div class="flex items-center flex-1 bg-[#2a3942] rounded-full px-3 sm:px-4 py-2 sm:py-3">
      <input id="messageInput"
             type="text"
             placeholder="Ketik pesan..."
             class="flex-1 bg-transparent text-sm sm:text-base text-white outline-none placeholder-gray-400" />
    </div>
    <button id="sendBtn"
            class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-blue-400 hover:bg-blue-500 flex items-center justify-center transition">
      <i class="ri-send-plane-2-fill text-lg sm:text-xl text-white"></i>
    </button>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    // === Konfigurasi Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyBCz40oTe3y1bcpfxZY8wl4ZPf-Jm-Yn08",
      authDomain: "group-chat-5eb24.firebaseapp.com",
      projectId: "group-chat-5eb24",
      storageBucket: "group-chat-5eb24.firebasestorage.app",
      messagingSenderId: "1035715492375",
      appId: "1:1035715492375:web:3543ae1fcdecea8c0e7a52"
    };

    // === Inisialisasi Firebase ===
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, "cerydra_group");

    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const chatArea = document.getElementById('chatArea');

    // === Simpan username agar tetap sama ===
    let username = localStorage.getItem('username');
    if (!username) {
      username = "User_" + Math.floor(Math.random() * 1000);
      localStorage.setItem('username', username);
    }

    // === Fungsi render bubble ===
    function renderMessage(text, sender, time) {
      const isYou = sender === username;
      const bubble = document.createElement('div');
      bubble.className = `
        fade-in ${isYou ? "self-end bg-[#005c4b]" : "self-start bg-[#1f1f1f]"}
        ${isYou ? "text-white" : "text-gray-200"}
        rounded-2xl px-3 sm:px-4 py-2 sm:py-2.5 max-w-[80%] sm:max-w-[70%] text-sm sm:text-base shadow
      `;

      bubble.innerHTML = `
        <div class='flex items-end gap-2 flex-wrap justify-end'>
          <span class='break-words leading-tight'>${text}</span>
          <span class='flex items-center gap-1 text-[11px] sm:text-[12px] text-gray-300 whitespace-nowrap'>
            ${time}
            ${isYou ? "<i class='ri-check-double-line text-gray-400 text-[13px] sm:text-[14px]'></i>" : ""}
          </span>
        </div>
        ${!isYou ? `<div class='text-[11px] text-gray-400 mt-1 ml-1'>${sender}</div>` : ""}
      `;
      chatArea.appendChild(bubble);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // === Muat cache lokal dulu ===
    const cachedData = JSON.parse(localStorage.getItem('chat_cache') || '[]');
    cachedData.forEach(m => renderMessage(m.text, m.sender, m.time));

    // === Realtime listener (sync penuh dari Firebase) ===
    onValue(chatRef, snapshot => {
      const data = snapshot.val();
      if (!data) return;
      const messages = Object.entries(data).map(([id, val]) => ({ id, ...val }));
      localStorage.setItem('chat_cache', JSON.stringify(messages));

      // Render ulang chat (tanpa duplikat, tanpa hilang)
      chatArea.innerHTML = "";
      messages.forEach(m => renderMessage(m.text, m.sender, m.time));
    });

    // === Kirim Pesan ===
    sendBtn.addEventListener('click', () => {
      const text = input.value.trim();
      if (!text) return;
      const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      push(chatRef, { text, sender: username, time });
      input.value = '';
    });

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });
  </script>
</body>
</html>