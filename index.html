<!doctype html>
<html lang="id" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PTIKH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">

  <style>
  
/* Gaya untuk pesan yang dihapus */
.deleted-message {
  color: #9ca3af; /* abu-abu netral */
  font-style: italic;
}

#customPlaceholder {
  font-style: italic;
  color: #9ca3af;
  z-index: 10;
}

/* --- Popup verifikasi animasi fix --- */
#verifyOverlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  display: flex;
  align-items: flex-end;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 99;
}

#verifyOverlay.show {
  opacity: 1;
}

#verifyOverlay.hidden {
  display: none;
}

#verifyPopup {
  background: #1f2a36;
  color: #fff;
  border-radius: 20px 20px 0 0;
  text-align: center;
  width: 100%;
  max-width: 450px;
  padding: 30px 20px;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
  box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.3);
}

#verifyPopup.show {
  transform: translateY(0);
}

#verifyPopup.hide {
  transform: translateY(100%);
}

/* Tambahan efek bounce kecil */
#verifyPopup.show {
  animation: popup-bounce 0.4s ease-out;
}

@keyframes popup-bounce {
  0% {
    transform: translateY(100%);
  }
  70% {
    transform: translateY(0);
  }
  100% {
    transform: translateY(0);
  }
}
/* Placeholder jadi miring dan abu-abu saat disabled */
input[disabled]::placeholder {
  font-style: italic;
  color: #9ca3af; /* abu-abu lembut */
}

/* warna background input nonaktif */
input[disabled] {
  background-color: transparent;
  color: #9ca3af;
  cursor: not-allowed;
}

    :root { --vh: 100%; }
    body {
      background-color: #0b141a;
      color: #fff;
      font-family: 'Inter', sans-serif;
      display: flex;
      overflow: hidden;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    
.verified-badge {
  display: inline-block;
  vertical-align: middle;
  margin-top: -2.5px; /* sedikit naik supaya sejajar sempurna */
}

.verified-badge-style-two {
  display: inline-block;
  vertical-align: middle;
  margin-top: -2px; /* sedikit naik supaya sejajar sempurna */
}
  
#chatArea {
  overflow-y: auto;
  scroll-behavior: smooth;
  transition: scroll 0.4s ease-out;
  height: 100%;
  width: 100%;
  will-change: scroll-position;
  padding-bottom: 100px !important;
}
    main {
  flex: 1;
  overflow-y: auto;
  scroll-behavior: smooth;
}
footer {
  position: fixed !important;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 900px; /* agar tetap proporsional di tengah */
  z-index: 50;
}

#loginOverlay {
  backdrop-filter: blur(2px);
  font-weight: 500;
}
  </style>
</head>
<body class="min-h-screen flex flex-col" id="body">

  <!-- Header -->
    <header class="sticky top-0 z-20 flex justify-between items-center bg-[#202c33] px-4 py-3 shadow-md">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full overflow-hidden">
        <img src="
        https://media.tenor.com/bZId7Fns3DoAAAAM/cerydra-hsr.gif"
             alt="pp saluran" class="w-full h-full object-cover">
      </div>
      <div class="flex flex-col text-sm sm:text-base">
        <span class="font-semibold flex items-center gap-1 text-white">

            
          KSD Tbk.
         

          <img src="https://lookaside.fbsbx.com/elementpath/media/?media_id=778731283935334&version=1760038331"
               alt="verified"
               class="w-3 h-3 sm:w-4 sm:h-4 object-contain" />
               
         
        </span>
        <span class="text-xs sm:text-sm text-gray-400">PT Karya Surya DreVviann</span>
      </div>
    </div>

    <!-- User/Login Area -->
    <div id="userArea" class="text-sm sm:text-base">
      <button id="loginBtn" class="bg-transparent border border-white px-2 py-1 rounded-lg transition text-white">                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/480px-Google_%22G%22_logo.svg.png"
               alt="verified"
               class="w-6 h-6 sm:w-5 sm:h-5 object-contain" /></button>
    </div>
  </header>

<section class="flex-1 overflow-hidden relative">
  <div id="chatArea"
       class="absolute inset-0 overflow-y-auto bg-[url('https://i.pinimg.com/564x/54/3d/e8/543de8a1f2887da54f7b7de6772f6aa2.jpg')] bg-cover bg-center p-3 sm:p-4 space-y-3 sm:space-y-4">
  </div>
</section>
  
  <!-- ðŸ”” Notifikasi jumlah pesan baru -->
<div id="newMsgPopup"
     class="hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-blue-500 text-white px-4 py-2 rounded-full text-sm shadow-lg cursor-pointer z-50 transition">
  1 pesan baru
</div>

<!-- Input Area -->
<footer class="flex items-center gap-2 sm:gap-3 bg-[#202c33] p-2 sm:p-3 relative">
  <!-- Tombol + -->
  <button id="openStickerBtn"
          class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[#2a3942] hover:bg-[#3b4a54] flex items-center justify-center text-white transition">
    <i class="ri-add-line text-xl"></i>
  </button>
  
  <!-- Tombol Admin Panel -->
<button id="adminPanelBtn"
        class="hidden w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-[#2a3942] hover:bg-[#3b4a54] flex items-center justify-center text-white transition">
  <i class="ri-settings-3-line text-xl"></i>
</button>


  <!-- Input -->
  <div class="flex items-center flex-1 bg-[#2a3942] rounded-full px-3 sm:px-4 py-2 sm:py-3">
    <input id="messageInput"
           type="text"
           placeholder="Ketik pesan..."
           class="flex-1 bg-transparent text-sm sm:text-base text-white outline-none placeholder-gray-400" />
           
  </div>
  <div id="customPlaceholder" class="absolute left-4 bottom-3 text-gray-400 italic flex items-center pointer-events-none hidden">
  <i class="ri-forbid-2-line text-gray-400 text-base mr-1"></i> Login terlebih dahulu untuk mengirim pesan!
</div>

  <!-- Tombol kirim -->
  <button id="sendBtn"
          class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-blue-400 hover:bg-blue-500 flex items-center justify-center transition">
    <i class="ri-send-plane-2-fill text-lg sm:text-xl text-white"></i>
  </button>

  <!-- Popup Sticker -->
  <div id="stickerPanel"
       class="hidden absolute bottom-16 left-2 bg-[#1f2c34] p-3 rounded-2xl shadow-xl grid grid-cols-4 sm:grid-cols-5 gap-2 border border-gray-700 z-50">
    <!-- contoh gambar sticker -->
    <img src="https://media.tenor.com/lD7DpilxezIAAAAM/cerydra-cery-dra.gif" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
    <img src="https://github.com/Drevviann/group-chat/blob/main/IMG-20251015-WA0184.jpg?raw=true" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
        <img src="https://media2.giphy.com/media/v1.Y2lkPTZjMDliOTUybW04Z2Zjdm1qd245MXBrcDQ0OHljbGRzbzZlaHF5c3RsZGVua3A4aSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Q0VvDkS4j4Ia2RjAOS/giphy.gif" class="w-14 h-14 rounded-lg cursor-pointer hover:opacity-80 transition" />
  </div>
</footer>

<!-- Overlay untuk user yang belum login -->
<div id="loginOverlay"
     class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 flex items-center justify-center text-gray-300 text-sm sm:text-base py-4 z-40 hidden">
  Login terlebih dahulu!
</div>

<div id="verifyOverlay" class="hidden">
  <div id="verifyPopup" class="flex flex-col items-center">
    <!-- ðŸ”µ Ikon centang biru dengan latar bulat hitam -->
    <div class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center mb-3">
      <img src="https://lookaside.fbsbx.com/elementpath/media/?media_id=778731283935334&version=1760038331"
           alt="verified"
           class="w-8 h-8 object-contain" />
    </div>

    <h3 class="text-lg font-semibold">Terverifikasi</h3>

    <p class="text-gray-400 text-sm mt-2 leading-relaxed text-center">
      KSD, perusahaan induk QualityeXchange, telah memverifikasi akun ini berdasarkan aktivitasnya di seluruh produk kami serta informasi atau dokumen yang mereka sediakan.
    </p>

    <p class="text-[#4ba3ff] text-sm mt-3">
      KSD Verification. Powered by QualityeXchange
    </p>
  </div>
</div>

<script type="module">
  import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  getDatabase,
  ref,
  set,
  push,
  update,
  onChildAdded,
  onChildChanged,
  onValue
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
  const firebaseConfig = {
    apiKey: "AIzaSyBCz40oTe3y1bcpfxZY8wl4ZPf-Jm-Yn08",
    authDomain: "group-chat-5eb24.firebaseapp.com",
    projectId: "group-chat-5eb24",
    storageBucket: "group-chat-5eb24.firebasestorage.app",
    databaseURL: "https://group-chat-5eb24-default-rtdb.firebaseio.com",
    messagingSenderId: "1035715492375",
    appId: "1:1035715492375:web:3543ae1fcdecea8c0e7a52"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, "cerydra_group");
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");
  const chatArea = document.getElementById("chatArea");
  const userArea = document.getElementById("userArea");
  const popup = document.getElementById("newMsgPopup");

  let username = localStorage.getItem("username") || "Guest_" + Math.floor(Math.random() * 1000);
  let isLoggedIn = false;
  let newMsgCount = 0;
  let isNearBottom = true;

  // --- Nama user maksimum 3 huruf ---
  function shortName(name) {
    return name.length > 3 ? name.substring(0, 3).toUpperCase() + "..." : name.toUpperCase();
  }

function updateUserUI(user) {
  if (user) {
    isLoggedIn = true;
    username = user.displayName || username;
    localStorage.setItem("username", username);

    // âœ… Cek apakah user adalah admin terverifikasi
    const verifiedAdmins = [
      "drevviann@gmail.com",
      "ridhofadillah1010@gmail.com"
    ];
    const isVerified = verifiedAdmins.includes(user.email);

    // âœ… Jika admin, beri centang biru di navbar
    const verifiedBadge = isVerified
  ? `<img src="https://lookaside.fbsbx.com/elementpath/media/?media_id=778731283935334&version=1760038331"
          alt="verified"
          class="verified-badge w-3 h-3 ml-1" />`
  : "";

    const displayName = shortName(username);
    userArea.innerHTML = `
      <div class="flex items-center gap-2">
        <img src="${user.photoURL || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRCIzI0ns7NQEyDF3q4uSycytPQglRhRPVNm4s1qWhdUg&s=10"}"
             class="w-8 h-8 rounded-full border border-gray-600">
        <span id="displayUsername" class="font-medium ${isVerified ? 'text-red-500' : 'text-white'}">${displayName}${verifiedBadge}</span>
        <i id="editName" class="ri-pencil-line text-gray-300 hover:text-white text-lg cursor-pointer"></i>
        <i id="logoutBtn" class="ri-logout-box-r-line text-red-400 hover:text-red-500 text-lg cursor-pointer"></i>
      </div>
    `;

    document.getElementById("editName").addEventListener("click", editUsername);
    document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));
  } else {
    isLoggedIn = false;
    userArea.innerHTML = `
      <button id="loginBtn"
              class="bg-transparent border border-white px-2 py-1 rounded-lg transition text-white">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/480px-Google_%22G%22_logo.svg.png"
             alt="google login"
             class="w-6 h-6 sm:w-5 sm:h-5 object-contain" />
      </button>`;
    document.getElementById("loginBtn").addEventListener("click", handleLogin);
    
  }
  const input = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  if (user) {
    // âœ… User sudah login
    input.disabled = false;
    input.placeholder = "Kirim pesan...";
    sendBtn.disabled = false;
    sendBtn.classList.remove("opacity-50", "cursor-not-allowed");
} else {
    input.disabled = true;
    input.placeholder = "!disabled! Login terlebih dahulu!";
    sendBtn.disabled = true;
    sendBtn.classList.add("opacity-50", "cursor-not-allowed");
  }
}

  function handleLogin() {
    signInWithPopup(auth, provider)
      .then(result => updateUserUI(result.user))
      .catch(err => console.error("Login error:", err));
  }

  function editUsername() {
    if (!isLoggedIn) return alert("Hanya pengguna login yang bisa mengganti nama!");
    const newName = prompt("Ubah nama (maks. 12 karakter):", username);
    if (!newName) return;
    if (newName.length > 12) return alert("Maksimal 12 karakter!");
    username = newName.trim();
    localStorage.setItem("username", username);
    document.getElementById("displayUsername").innerText = shortName(username);
  }

  onAuthStateChanged(auth, user => updateUserUI(user));

function renderMessage(text, sender, time, email = null, photoURL = null, messageId = null) {    // Potong nama jika lebih dari 12 karakter
  const displayName = sender.length > 12 ? sender.substring(0, 12) + "..." : sender;
  const currentUser = auth.currentUser;
  const isYou = currentUser && email === currentUser.email;

  // ðŸ”¹ daftar akun terverifikasi
  const verifiedUsers = [
    "drevviann@gmail.com",
    "ridhofadillah1010@gmail.com"
  ];
  const isVerified = verifiedUsers.includes(email);

  // wrapper bubble
  const wrapper = document.createElement("div");
  wrapper.className = `w-full flex ${isYou ? "justify-end" : "justify-start"} mb-3`;

  // bubble chat
  const bubble = document.createElement("div");
  bubble.className = `
    ${isYou ? "bg-[#005c4b]" : "bg-[#1f1f1f]"}
    text-gray-200 rounded-2xl px-3 py-2 max-w-[80%] text-sm shadow
    flex flex-col items-start
  `
  bubble.dataset.id = messageId;
  
  // ðŸ§© Tekan-tahan untuk hapus pesan sendiri
  let pressTimer;
  if (auth.currentUser && auth.currentUser.email === email && !text.includes("Pesan ini sudah dihapus")) { 
    const startPress = () => {
      pressTimer = setTimeout(() => {
        showDeletePopup(messageId);
      }, 700);
    };
    const endPress = () => clearTimeout(pressTimer);

    bubble.addEventListener("mousedown", startPress);
    bubble.addEventListener("mouseup", endPress);
    bubble.addEventListener("mouseleave", endPress);
    bubble.addEventListener("touchstart", startPress);
    bubble.addEventListener("touchend", endPress);
  }
  

  // ðŸ”¹ centang biru jika terverifikasi
  const verifiedBadge = isVerified
    ? `<img src="https://lookaside.fbsbx.com/elementpath/media/?media_id=778731283935334&version=1760038331"
             alt="verified" class="w-3 h-3 ml-1 inline-block align-middle verified-badge-style-two" />`
    : "";

  // ðŸ”¹ Baris atas: foto profil di kiri nama + waktu di kanan
  const headerHTML = `
  <div class="flex items-center w-full mb-1">
    <img src="${photoURL || 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRkjFpo1MyqtOZpX9eN2FpREP7noUsAvV_IDw&usqp=CAU'}"
         alt="profile"
         class="w-6 h-6 rounded-full object-cover mr-2" />
<span class="font-medium ${isVerified ? "text-red-500" : "text-white"}">${displayName}</span>
    ${verifiedBadge}
    <span class="text-[11px] text-gray-400 ml-2">${time}</span>
  </div>
`;

  // ðŸ”¹ Deteksi pesan teks atau sticker
  const contentHTML = text.includes("<img")
  ? `<div class="mt-1 w-full flex justify-center message-body">${text}</div>`
  : `<div class="break-words leading-tight text-left text-white w-full message-body">${text}</div>`;

  bubble.innerHTML = headerHTML + contentHTML;
  wrapper.appendChild(bubble);
  chatArea.appendChild(wrapper);
}

function showDeletePopup(messageId) {
  const popup = document.createElement("div");
  popup.className = "fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50";
  popup.innerHTML = `
    <div class="bg-[#1f2c34] text-white p-4 rounded-2xl w-72 shadow-lg border border-gray-700">
      <p class="mb-4">Hapus pesan ini?</p>
      <button id="deleteForAll" class="w-full bg-transparent border border-red-700 rounded-lg py-2 mb-2">
        Hapus untuk semua orang
      </button>
      <button id="cancelDelete" class="w-full bg-transparent border border-white rounded-lg py-2">
        Batal
      </button>
    </div>
  `;
  document.body.appendChild(popup);

  // tombol hapus
  document.getElementById("deleteForAll").addEventListener("click", async () => {
    await update(ref(db, "cerydra_group/" + messageId), {
  text: "<i class='ri-forbid-2-line text-gray-400 text-base mr-1 align-middle'></i> <span class='deleted-message'>Pesan ini telah dihapus</span>"
});
    document.body.removeChild(popup);
  });

  document.getElementById("cancelDelete").addEventListener("click", () => {
    document.body.removeChild(popup);
  });
}

// ðŸ”¥ Saat ada pesan baru
onChildAdded(chatRef, snapshot => {
  const m = snapshot.val();
  if (!m) return;

  renderMessage(m.text, m.sender, m.time, m.email, m.photoURL, snapshot.key);

  // âœ… Tambahkan auto scroll setelah pesan baru dirender
  requestAnimationFrame(() => {
    smoothScrollToBottom(chatArea);
  });
});
// ðŸ”¥ Saat pesan diubah (misalnya dihapus)
onChildChanged(chatRef, snapshot => {
  const m = snapshot.val();
  const bubble = document.querySelector(`[data-id='${snapshot.key}']`);
  if (!bubble || !m) return;

  // cari elemen teks di dalam bubble
  const messageBody = bubble.querySelector(".message-body");
  if (messageBody) {
    messageBody.innerHTML = m.text;
  } else {
    // kalau struktur berbeda, fallback: ganti seluruh isi
    bubble.innerHTML = `
      <div class="message-header flex items-center gap-2">
        <img src="${m.photoURL || "https://cdn-icons-png.flaticon.com/512/4712/4712035.png"}" class="w-6 h-6 rounded-full">
        <span class="font-medium">${m.sender}</span>
        <span class="text-xs text-gray-400 ml-2">${m.time}</span>
      </div>
      <div class="message-body mt-1">${m.text}</div>
    `;
  }
});

// Animasi scroll halus
function smoothScrollToBottom(element) {
  const start = element.scrollTop;
  const end = element.scrollHeight - element.clientHeight;
  const distance = end - start;
  if (distance < 5) return;

  const duration = 500;
  const startTime = performance.now();

  function easeOutCubic(t) {
    return 1 - Math.pow(1 - t, 3);
  }

  function animate(time) {
    const elapsed = time - startTime;
    const progress = Math.min(elapsed / duration, 1);
    element.scrollTop = start + distance * easeOutCubic(progress);
    if (progress < 1) requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

  // --- Kirim pesan ---
  sendBtn.addEventListener("click", () => {
    if (!isLoggedIn) return alert("Silakan login terlebih dahulu!");
    const text = input.value.trim();
    if (!text) return;
    const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    const currentUser = auth.currentUser;
    push(chatRef, {
  text,
  sender: username,
  time,
  email: currentUser.email,
  photoURL: currentUser.photoURL || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRCIzI0ns7NQEyDF3q4uSycytPQglRhRPVNm4s1qWhdUg&s=10"
})
      .then(() => {
        input.value = "";
        input.focus();
        chatArea.scrollTop = chatArea.scrollHeight;
      })
      .catch(err => console.error("Send error:", err));
  });
  
  // --- Panel Sticker ---
const openStickerBtn = document.getElementById("openStickerBtn");
const stickerPanel = document.getElementById("stickerPanel");

openStickerBtn.addEventListener("click", () => {
  stickerPanel.classList.toggle("hidden");
});

// Klik di luar panel â†’ sembunyikan
document.addEventListener("click", (e) => {
  if (!stickerPanel.contains(e.target) && !openStickerBtn.contains(e.target)) {
    stickerPanel.classList.add("hidden");
  }
});

// Klik salah satu sticker â†’ kirim URL-nya sebagai pesan
stickerPanel.querySelectorAll("img").forEach(img => {
  img.addEventListener("click", () => {
    if (!isLoggedIn) return alert("Silakan login untuk mengirim pesan!");
    const currentUser = auth.currentUser;
    const time = new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });

    push(chatRef, {
  text: `<img src="${img.src}" class='w-32 h-32 rounded-lg' />`,
  sender: username,
  time,
  email: currentUser.email,
  photoURL: currentUser.photoURL || "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRCIzI0ns7NQEyDF3q4uSycytPQglRhRPVNm4s1qWhdUg&s=10"
});

    stickerPanel.classList.add("hidden");
    chatArea.scrollTop = chatArea.scrollHeight;
  });
});

const verifyPopup = document.getElementById("verifyPopup");
const verifyOverlay = document.getElementById("verifyOverlay");

function openVerifyPopup() {
  verifyPopup.classList.add("show");
  verifyPopup.classList.remove("hide");
  verifyOverlay.classList.remove("hidden");
  verifyOverlay.classList.add("show");
}

function closeVerifyPopup() {
  verifyPopup.classList.add("hide");
  verifyPopup.classList.remove("show");
  verifyOverlay.classList.remove("show");
  setTimeout(() => verifyOverlay.classList.add("hidden"), 300);
}

// Event untuk semua centang biru (ikon Remixicon atau gambar alt="verified")
document.addEventListener("click", e => {
  if (
    e.target.classList.contains("ri-verified-badge-fill") ||
    e.target.classList.contains("ri-verified-badge-line") ||
    e.target.alt === "verified"
  ) {
    e.stopPropagation();
    openVerifyPopup();
  }
});

// Tutup popup bila klik area overlay
verifyOverlay.addEventListener("click", closeVerifyPopup);

</script>
</body>
</html>